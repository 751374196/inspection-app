name: Build Android APK

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash -l {0}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        cache: 'pip'
    
    - name: Verify Python version
      run: |
        python3 --version
        which python3
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          git \
          ffmpeg \
          libsdl2-dev \
          libsdl2-image-dev \
          libsdl2-mixer-dev \
          libsdl2-ttf-dev \
          libportmidi-dev \
          libswscale-dev \
          libavformat-dev \
          libavcodec-dev \
          zlib1g-dev \
          libgstreamer1.0-dev \
          gstreamer1.0-plugins-base \
          gstreamer1.0-plugins-good \
          autoconf \
          automake \
          libtool \
          pkg-config \
          libncurses-dev \
          cmake \
          libffi-dev \
          libssl-dev \
          openjdk-17-jdk \
          zip \
          unzip \
          libltdl-dev \
          zlib1g-dev \
          patchelf

    # æ ¸å¿ƒä¿®å¤ï¼šåŠ¨æ€æ¢æµ‹ç›®å½•å±‚çº§ + å…¨é“¾è·¯æ ¡éªŒ + é€‚é…ä»»æ„è§£å‹ç»“æ„
    - name: Fix SDK path & accept licenses (final fix)
      run: |
        # å®šä¹‰ç»å¯¹SDKæ ¹è·¯å¾„ï¼Œå…¨ç¨‹ç»Ÿä¸€ä½¿ç”¨
        SDK_ROOT=/home/runner/.buildozer/android/platform/android-sdk
        # 1. æ¸…ç©ºæ—§ç›®å½•ï¼Œé¿å…å†²çªï¼ˆå«ä¸´æ—¶ç›®å½•+SDKæ—§å·¥å…·ç›®å½•ï¼‰
        rm -rf $SDK_ROOT/cmdline-tools /tmp/cmdline-tools /tmp/cmdline-tools.zip
        # 2. é€’å½’åˆ›å»ºæ‰€æœ‰å¿…è¦ç›®å½•ï¼Œç¡®ä¿è·¯å¾„å­˜åœ¨
        mkdir -p $SDK_ROOT/cmdline-tools/latest $SDK_ROOT/tools/bin $SDK_ROOT/platform-tools
        # 3. ä¸‹è½½cmdline-toolsï¼ˆ3æ¬¡é‡è¯•+æ˜¾ç¤ºæ—¥å¿—ï¼Œæ’æŸ¥ç½‘ç»œé—®é¢˜ï¼‰
        wget --tries=3 https://dl.google.com/android/repository/commandlinetools-linux-10406996_latest.zip -O /tmp/cmdline-tools.zip
        # 4. è§£å‹åˆ°ä¸´æ—¶ç›®å½•ï¼ˆå¼ºåˆ¶è¦†ç›–+æ˜¾ç¤ºæ—¥å¿—ï¼‰
        unzip -o /tmp/cmdline-tools.zip -d /tmp/
        # æ ¸å¿ƒï¼šåŠ¨æ€æ¢æµ‹è§£å‹åçš„å®é™…ç›®å½•ç»“æ„ï¼ˆé€‚é…å•å±‚/åŒå±‚åµŒå¥—ï¼‰
        echo "ğŸ” æŸ¥çœ‹è§£å‹åç›®å½•ç»“æ„ï¼Œè‡ªåŠ¨é€‚é…è·¯å¾„"
        ls -l /tmp/
        ls -l /tmp/cmdline-tools/
        # åˆ¤æ–­æ˜¯åŒå±‚åµŒå¥—è¿˜æ˜¯å•å±‚ç›®å½•ï¼Œé€‰æ‹©æ­£ç¡®çš„æºè·¯å¾„
        if [ -d "/tmp/cmdline-tools/cmdline-tools" ]; then
          TOOL_SRC=/tmp/cmdline-tools/cmdline-tools
          echo "ğŸ“Œ æ£€æµ‹åˆ°åŒå±‚åµŒå¥—ç›®å½•ï¼Œä½¿ç”¨è·¯å¾„ï¼š$TOOL_SRC"
        else
          TOOL_SRC=/tmp/cmdline-tools
          echo "ğŸ“Œ æ£€æµ‹åˆ°å•å±‚ç›®å½•ï¼Œä½¿ç”¨è·¯å¾„ï¼š$TOOL_SRC"
        fi
        # 5. ç§»åŠ¨å·¥å…·æ–‡ä»¶åˆ°æŒ‡å®šç›®å½•ï¼Œä¿ç•™å®Œæ•´ç»“æ„
        mv $TOOL_SRC/* $SDK_ROOT/cmdline-tools/latest/
        # 6. éªŒè¯æ ¸å¿ƒæ–‡ä»¶sdkmanageræ˜¯å¦å­˜åœ¨ï¼Œå…³é”®æ ¡éªŒ
        if [ ! -f "$SDK_ROOT/cmdline-tools/latest/bin/sdkmanager" ]; then
          echo "âŒ æ ¸å¿ƒæ–‡ä»¶sdkmanagerç¼ºå¤±ï¼Œä¸‹è½½/è§£å‹/ç§»åŠ¨å¤±è´¥"
          echo "ğŸ” æŸ¥çœ‹SDKå·¥å…·ç›®å½•å®é™…æ–‡ä»¶ï¼š"
          ls -l $SDK_ROOT/cmdline-tools/latest/
          ls -l $SDK_ROOT/cmdline-tools/latest/bin/ 2>&1 || echo "binç›®å½•ä¸å­˜åœ¨"
          exit 1
        fi
        echo "âœ… cmdline-toolsç›®å½•å¤„ç†æˆåŠŸï¼Œsdkmanagerå·²å­˜åœ¨"
        # 7. åˆ›å»ºè½¯é“¾æ¥ï¼Œæ˜ å°„åˆ°Buildozeré»˜è®¤æŸ¥æ‰¾è·¯å¾„
        ln -sf $SDK_ROOT/cmdline-tools/latest/bin/sdkmanager $SDK_ROOT/tools/bin/sdkmanager
        ln -sf $SDK_ROOT/cmdline-tools/latest/bin/avdmanager $SDK_ROOT/tools/bin/avdmanager
        # 8. ç»™å®é™…è„šæœ¬èµ‹å¯æ‰§è¡Œæƒé™ï¼ˆè½¯é“¾æ¥ç»§æ‰¿æƒé™ï¼‰
        chmod +x $SDK_ROOT/cmdline-tools/latest/bin/sdkmanager $SDK_ROOT/cmdline-tools/latest/bin/avdmanager
        # 9. é…ç½®ç¯å¢ƒå˜é‡ï¼Œæå‡SDKè·¯å¾„ä¼˜å…ˆçº§
        export ANDROID_HOME=$SDK_ROOT
        export ANDROID_SDK_ROOT=$SDK_ROOT
        export PATH=$SDK_ROOT/tools/bin:$SDK_ROOT/cmdline-tools/latest/bin:$SDK_ROOT/platform-tools:$PATH
        # 10. æ ¡éªŒè½¯é“¾æ¥æ˜¯å¦æœ‰æ•ˆä¸”å¯æ‰§è¡Œ
        if [ -x "$SDK_ROOT/tools/bin/sdkmanager" ]; then
          echo "âœ… è½¯é“¾æ¥éªŒè¯æˆåŠŸï¼ŒBuildozerå¯è¯†åˆ«sdkmanager"
          $SDK_ROOT/tools/bin/sdkmanager --version 2>&1 | head -n1
        else
          echo "âŒ è½¯é“¾æ¥æ— æ•ˆæˆ–æ— æ‰§è¡Œæƒé™"
          ls -l $SDK_ROOT/tools/bin/
          exit 1
        fi
        # 11. è‡ªåŠ¨æ¥å—æ‰€æœ‰Android SDKè®¸å¯è¯ï¼ˆå¿½ç•¥å…¼å®¹è­¦å‘Šï¼‰
        echo "y" | $SDK_ROOT/tools/bin/sdkmanager --licenses 2>&1 || echo "âš ï¸  è®¸å¯è¯æ¥å—å®Œæˆï¼ˆå¿½ç•¥SDKç‰ˆæœ¬å…¼å®¹è­¦å‘Šï¼‰"
        # 12. å®‰è£…å¿…å¤‡Androidç»„ä»¶ï¼ŒBuildozerç¼–è¯‘å¿…é¡»
        echo "y" | $SDK_ROOT/tools/bin/sdkmanager "build-tools;36.1.0" "platform-tools" "platforms;android-31" 2>&1
        # 13. éªŒè¯Build-Toolsæ˜¯å¦å®‰è£…æˆåŠŸï¼Œç¡®ä¿aidlå­˜åœ¨
        if [ -d "$SDK_ROOT/build-tools/36.1.0" ]; then
          echo "âœ… Build-Tools 36.1.0å®‰è£…æˆåŠŸï¼Œaidlå·¥å…·å·²å°±ç»ª"
        else
          echo "âš ï¸  Build-Toolså®‰è£…å¤±è´¥ï¼Œé‡æ–°å°è¯•å®‰è£…"
          echo "y" | $SDK_ROOT/tools/bin/sdkmanager "build-tools;36.1.0"
        fi
        # 14. æ¸…ç†ä¸´æ—¶æ–‡ä»¶ï¼ŒèŠ‚çœæ„å»ºç©ºé—´
        rm -rf /tmp/cmdline-tools /tmp/cmdline-tools.zip
        echo "âœ… SDKç¯å¢ƒåˆå§‹åŒ–å…¨éƒ¨å®Œæˆï¼Œæ— è·¯å¾„/æ–‡ä»¶ç¼ºå¤±é—®é¢˜"

    # âœ… å…³é”®ä¿®æ”¹ï¼šå…¨å±€å®‰è£…Buildozer+æŒ‡å®šç‰ˆæœ¬Cythonï¼ˆé€‚é…Buildozer1.5.0ï¼‰
    - name: Install Buildozer and Cython (fixed compatible version)
      run: |
        # å…¨å±€å®‰è£…ï¼Œç¡®ä¿ç³»ç»Ÿæ‰€æœ‰Pythonè¿›ç¨‹éƒ½èƒ½æ‰¾åˆ°Cython
        sudo pip3 install buildozer==1.5.0 cython==0.29.36
        # åŠ å…¥è·¯å¾„ï¼Œå…œåº•ä¿éšœ
        echo "/home/runner/.local/bin" >> $GITHUB_PATH
    
    - name: Display Buildozer version
      run: buildozer --version

    # éªŒè¯Gitå®‰è£…å¹¶å¼ºåˆ¶æ³¨å…¥ç¯å¢ƒå˜é‡ï¼ˆè§£å†³Git not foundï¼‰
    - name: Verify Git and fix PATH
      run: |
        # éªŒè¯gitæ˜¯å¦çœŸçš„å®‰è£…ï¼Œè¾“å‡ºå®é™…è·¯å¾„
        which git
        git --version
        # æŠŠgitè·¯å¾„å¼ºåˆ¶åŠ å…¥GITHUB_PATHï¼Œè®©æ‰€æœ‰åç»­æ­¥éª¤ç»§æ‰¿
        echo "$(dirname $(which git))" >> $GITHUB_PATH
        echo "âœ… Gitè·¯å¾„å·²å¼ºåˆ¶æ³¨å…¥ï¼ŒBuildozerå¯è¯†åˆ«"
    
    - name: Build Android APK
      run: |
        # æ„å»ºå‰å†ç¡®è®¤gitå’ŒCythonï¼ŒåŒé‡å…œåº•
        git --version
        python3 -c "import Cython; print('Cython version:', Cython.__version__)"
        buildozer --yes android release -vv
      env:
        ANDROID_HOME: /home/runner/.buildozer/android/platform/android-sdk
        ANDROID_SDK_ROOT: /home/runner/.buildozer/android/platform/android-sdk
        ANDROID_NDK_ROOT: /home/runner/.buildozer/android/platform/android-ndk-r25b
        PYTHONUNBUFFERED: 1
        TERM: dumb
        # å…œåº•ï¼šæŠŠgité»˜è®¤è·¯å¾„ç›´æ¥åŠ å…¥ç¯å¢ƒå˜é‡
        PATH: /usr/bin:$SDK_ROOT/tools/bin:$SDK_ROOT/cmdline-tools/latest/bin:$PATH
    
    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: android-apk
        path: bin/*.apk
        retention-days: 30
