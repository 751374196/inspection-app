name: Build Android APK

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash -l {0}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        cache: 'pip'
    
    - name: Verify Python version
      run: |
        python3 --version
        which python3
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          git \
          ffmpeg \
          libsdl2-dev \
          libsdl2-image-dev \
          libsdl2-mixer-dev \
          libsdl2-ttf-dev \
          libportmidi-dev \
          libswscale-dev \
          libavformat-dev \
          libavcodec-dev \
          zlib1g-dev \
          libgstreamer1.0-dev \
          gstreamer1.0-plugins-base \
          gstreamer1.0-plugins-good \
          autoconf \
          automake \
          libtool \
          pkg-config \
          libncurses-dev \
          cmake \
          libffi-dev \
          libssl-dev \
          openjdk-17-jdk \
          zip \
          unzip \
          libltdl-dev \
          zlib1g-dev \
          patchelf

    # æ ¸å¿ƒä¿®å¤ï¼šåŠ¨æ€æ¢æµ‹SDKç›®å½•å±‚çº§ + å…¨é“¾è·¯æ ¡éªŒ
    - name: Fix SDK path & accept licenses (final fix)
      run: |
        SDK_ROOT=/home/runner/.buildozer/android/platform/android-sdk
        rm -rf $SDK_ROOT/cmdline-tools /tmp/cmdline-tools /tmp/cmdline-tools.zip
        mkdir -p $SDK_ROOT/cmdline-tools/latest $SDK_ROOT/tools/bin $SDK_ROOT/platform-tools
        wget --tries=3 https://dl.google.com/android/repository/commandlinetools-linux-10406996_latest.zip -O /tmp/cmdline-tools.zip
        unzip -o /tmp/cmdline-tools.zip -d /tmp/
        echo "ğŸ” é€‚é…SDKè§£å‹è·¯å¾„"
        ls -l /tmp/cmdline-tools/
        TOOL_SRC=/tmp/cmdline-tools/cmdline-tools if [ -d "/tmp/cmdline-tools/cmdline-tools" ]; then TOOL_SRC=/tmp/cmdline-tools/cmdline-tools; else TOOL_SRC=/tmp/cmdline-tools; fi
        mv $TOOL_SRC/* $SDK_ROOT/cmdline-tools/latest/
        if [ ! -f "$SDK_ROOT/cmdline-tools/latest/bin/sdkmanager" ]; then
          echo "âŒ SDKæ ¸å¿ƒæ–‡ä»¶ç¼ºå¤±"
          ls -l $SDK_ROOT/cmdline-tools/latest/
          exit 1
        fi
        ln -sf $SDK_ROOT/cmdline-tools/latest/bin/sdkmanager $SDK_ROOT/tools/bin/sdkmanager
        ln -sf $SDK_ROOT/cmdline-tools/latest/bin/avdmanager $SDK_ROOT/tools/bin/avdmanager
        chmod +x $SDK_ROOT/cmdline-tools/latest/bin/*
        export ANDROID_HOME=$SDK_ROOT && export ANDROID_SDK_ROOT=$SDK_ROOT
        export PATH=$SDK_ROOT/tools/bin:$SDK_ROOT/cmdline-tools/latest/bin:$PATH
        $SDK_ROOT/tools/bin/sdkmanager --version
        echo "y" | $SDK_ROOT/tools/bin/sdkmanager --licenses 2>&1 || echo "âš ï¸  è®¸å¯è¯æ¥å—å®Œæˆ"
        echo "y" | $SDK_ROOT/tools/bin/sdkmanager "build-tools;36.1.0" "platform-tools" "platforms;android-31" 2>&1
        if [ -d "$SDK_ROOT/build-tools/36.1.0" ]; then echo "âœ… SDKç¯å¢ƒåˆå§‹åŒ–å®Œæˆ"; else exit 1; fi
        rm -rf /tmp/cmdline-tools /tmp/cmdline-tools.zip

    # âœ… æ ¸å¿ƒï¼šå…¨å±€å®‰è£…Buildozer+Cython + åŠ¨æ€æ³¨å…¥è·¯å¾„ï¼ˆè§£å†³å‘½ä»¤æœªæ‰¾åˆ°ï¼‰
    - name: Install Buildozer & Cython (global + path fix)
      run: |
        # å…¨å±€å®‰è£…é€‚é…ç‰ˆæœ¬ï¼Œç¡®ä¿æ‰€æœ‰è¿›ç¨‹å¯è®¿é—®
        sudo pip3 install --upgrade pip
        sudo pip3 install buildozer==1.5.0 cython==0.29.36
        # åŠ¨æ€è·å–Buildozerå¯æ‰§è¡Œè·¯å¾„ï¼Œé¿å…ç¡¬ç¼–ç 
        BUILDOZER_PATH=$(which buildozer)
        BUILDOZER_DIR=$(dirname $BUILDOZER_PATH)
        # æ³¨å…¥åˆ°GitHubå…¨å±€PATHï¼Œæ‰€æœ‰åç»­æ­¥éª¤éƒ½èƒ½è¯†åˆ«
        echo "$BUILDOZER_DIR" >> $GITHUB_PATH
        echo "/usr/local/bin" >> $GITHUB_PATH # å…œåº•ï¼šå…¨å±€å®‰è£…é»˜è®¤è·¯å¾„
        # éªŒè¯å®‰è£…æˆåŠŸ
        buildozer --version
        python3 -c "import Cython; print('Cython:', Cython.__version__)"
        echo "âœ… Buildozer+Cythonå®‰è£…å®Œæˆï¼Œè·¯å¾„å·²æ³¨å…¥"

    # âœ… éªŒè¯æ‰€æœ‰æ ¸å¿ƒå·¥å…· + å…œåº•PATH
    - name: Verify all tools (Git/Buildozer/Cython)
      run: |
        # å…¨é‡éªŒè¯ï¼Œæå‰æ’æŸ¥é—®é¢˜
        git --version && echo "âœ… Gitæ­£å¸¸"
        buildozer --version && echo "âœ… Buildozeræ­£å¸¸"
        python3 -c "import Cython; print('Cython:', Cython.__version__)" && echo "âœ… Cythonæ­£å¸¸"
        # å¼ºåˆ¶æŠŠæ ¸å¿ƒè·¯å¾„åŠ å…¥PATHï¼ŒåŒé‡å…œåº•
        echo "/usr/bin:/usr/local/bin" >> $GITHUB_PATH
        echo "âœ… æ‰€æœ‰å·¥å…·éªŒè¯é€šè¿‡"
    
    # âœ… æœ€ç»ˆæ„å»ºAPKï¼ˆæ‰€æœ‰ä¾èµ–/è·¯å¾„å·²å…œåº•ï¼‰
    - name: Build Android APK
      run: |
        # æ„å»ºå‰æœ€åç¡®è®¤ç¯å¢ƒ
        echo "PATH: $PATH"
        buildozer --version
        # æ‰§è¡Œæ„å»ºï¼Œå¿½ç•¥éäº¤äº’å¼shellè­¦å‘Š
        buildozer --yes android release -vv 2>&1 | grep -v "Inappropriate ioctl for device"
      env:
        ANDROID_HOME: /home/runner/.buildozer/android/platform/android-sdk
        ANDROID_SDK_ROOT: /home/runner/.buildozer/android/platform/android-sdk
        ANDROID_NDK_ROOT: /home/runner/.buildozer/android/platform/android-ndk-r25b
        PYTHONUNBUFFERED: 1
        TERM: dumb
        # ç»ˆæå…œåº•ï¼šæ‰€æœ‰æ ¸å¿ƒè·¯å¾„åŠ å…¥ç¯å¢ƒå˜é‡
        PATH: /usr/bin:/usr/local/bin:$ANDROID_HOME/tools/bin:$ANDROID_HOME/cmdline-tools/latest/bin:$PATH
    
    # âœ… ä¸Šä¼ æ„å»ºå¥½çš„APKï¼ˆæ„å»ºæˆåŠŸåè‡ªåŠ¨ä¸Šä¼ ï¼‰
    - name: Upload Android APK
      uses: actions/upload-artifact@v4
      if: success() # ä»…æ„å»ºæˆåŠŸæ—¶æ‰§è¡Œ
      with:
        name: inspection-app-android-apk
        path: |
          bin/*.apk
          bin/*.aab
        retention-days: 30
